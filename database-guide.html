<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide: Deploying a Central MySQL Database with Docker & phpMyAdmin</title>

    <!-- Prism JS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    
    <style>
        /* --- THEME VARIABLES & GENERAL STYLING --- */
        :root {
            --bg-color: #f8f9fa; --main-bg-color: #ffffff; --text-color: #212529;
            --heading-color: #0056b3; --link-color: #007bff; --border-color: #dee2e6;
            --code-bg: #e9ecef; --code-text: #212529; --toc-bg: #e9f5ff;
            --toc-border: #007bff; --info-bg: #fff3cd; --info-border: #ffeeba;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05); --pre-bg: #2d2d2d;
        }
        [data-theme="dark"] {
            --bg-color: #121212; --main-bg-color: #1e1e1e; --text-color: #e0e0e0;
            --heading-color: #61afef; --link-color: #56b6c2; --border-color: #333;
            --code-bg: #2c2c2c; --code-text: #e0e0e0; --toc-bg: #2a3b4c;
            --toc-border: #61afef; --info-bg: #3e382b; --info-border: #b08900;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.7; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-size: 17px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 960px; margin: 0 auto; padding: 1rem 2rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); }
        main { padding: 2rem 0; }
        .content-card { background-color: var(--main-bg-color); border-radius: 12px; box-shadow: var(--shadow); padding: 2rem 3rem; }
        h1, h2, h3, h4 { color: var(--heading-color); line-height: 1.3; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; text-align: center; }
        h2 { font-size: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-top: 3rem; }
        h3 { font-size: 1.5rem; margin-top: 2.5rem; }
        p, li { font-size: 1.05rem; }
        a { color: var(--link-color); text-decoration: none; }
        a:hover { text-decoration: underline; }
        code { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; background-color: var(--code-bg); color: var(--code-text); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; }
        pre { background-color: var(--pre-bg); padding: 1.5rem; border-radius: 8px; overflow-x: auto; position: relative; font-size: 0.95rem; line-height: 1.5; margin: 1.5rem 0; }
        pre code { background-color: transparent; padding: 0; color: #ccc; }
        .token.comment { color: #6a9955 !important; }
        .copy-button { position: absolute; top: 12px; right: 12px; background-color: #4a505c; color: #e2e2e2; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; opacity: 0; transition: opacity 0.2s, background-color 0.2s; }
        pre:hover .copy-button { opacity: 1; }
        .copy-button:hover { background-color: #5c6370; }
        .toc, .info-box { padding: 1.5rem 2rem; margin: 2rem 0; border-left: 5px solid; border-radius: 8px; }
        .toc { background-color: var(--toc-bg); border-color: var(--toc-border); }
        .toc h3 { margin-top: 0; }
        .toc ul { padding-left: 20px; margin: 0; }
        .toc li { margin-bottom: 0.5rem; }
        .info-box { background-color: var(--info-bg); border-color: var(--info-border); }
        .info-box p:last-child, .info-box ul:last-child { margin-bottom: 0; }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: #61afef; }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider.round { border-radius: 24px; }
        .slider.round:before { border-radius: 50%; }
    </style>
</head>
<body>

    <header class="page-header">
        <h4>Database Guide</h4>
        <div class="theme-switch-wrapper">
            <span>‚òÄÔ∏è</span>
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
            <span>üåô</span>
        </div>
    </header>

    <div class="container">
        <main>
            <div class="content-card">
                <header style="text-align:center; margin-bottom: 3rem;">
                    <h1>Deploying a Central MySQL Database with Docker & phpMyAdmin</h1>
                    <p>A Secure, Persistent, and Scalable Database Setup</p>
                </header>

                <nav class="toc">
                    <h3>Table of Contents</h3>
                    <ul>
                        <li><a href="#section-1">Prerequisites & Architecture</a></li>
                        <li><a href="#section-2">Part 1: Setting Up the Database Service</a></li>
                        <li><a href="#section-3">Part 2: Securely Accessing phpMyAdmin</a></li>
                        <li><a href="#section-4">Part 3: Connecting Your Application</a></li>
                        <li><a href="#section-5">Part 4: Database Management</a></li>
                        <li><a href="#section-6">Part 5: Allowing External Connections (Advanced)</a></li>
                        <li><a href="#section-7">Part 6: Decommissioning the Database</a></li>
                    </ul>
                </nav>

                <section id="section-1">
                    <h2>Prerequisites & Architecture</h2>
                    <p>This guide assumes you have already completed the main "Deploying Multiple Flask Apps" guide. Specifically, you must have:</p>
                    <ul>
                        <li>A VPS with Docker and Docker Compose installed.</li>
                        <li>The shared Docker network named <code>nginx-proxy</code> created.</li>
                        <li>The Nginx Proxy Manager container up and running.</li>
                    </ul>
                    <div class="info-box">
                        <p><strong>Architecture Reminder:</strong> We are creating a new, independent service for our database. This decouples your data from your application logic. The primary connection method is over the secure, internal Docker network, which is fast and does not require exposing the database to the internet.</p>
                    </div>
                </section>
                
                <section id="section-2">
                    <h2>Part 1: Setting Up the Database Service</h2>
                    <h3>Step 1: Create the Project Directory</h3>
                    <p>On your server, create a dedicated directory for your database stack. This keeps it neatly separated from your other services.</p>
                    <pre><code class="language-bash"># This directory will live alongside your 'proxy-manager' and 'apps' folders
mkdir /root/docker-deployment/database
</code></pre>

                    <h3>Step 2: Create the Database `docker-compose.yml`</h3>
                    <p>This single file defines both the MySQL database and the phpMyAdmin management interface. The default configuration below is the most secure, as it does not expose the database port to the internet.</p>
                    <pre><code class="language-bash"># Create and open the file for editing
nano /root/docker-deployment/database/docker-compose.yml
</code></pre>
                    <p>Paste the following content into the file. This is the **standard, secure configuration**.</p>
                    <pre><code class="language-yaml">services:
  # --- The MySQL Database Service ---
  db:
    image: mysql:8.0
    container_name: mysql_db
    restart: unless-stopped
    environment:
      # IMPORTANT: Change these passwords to something strong and secret!
      MYSQL_ROOT_PASSWORD: YOUR_VERY_STRONG_ROOT_PASSWORD
      MYSQL_PASSWORD: YOUR_STRONG_USER_PASSWORD
      
      # These variables create a user and database on the first run.
      MYSQL_USER: flask_user
      MYSQL_DATABASE: flask_db
    volumes:
      # CRITICAL: This line persists your database data on the host machine.
      - ./mysql-data:/var/lib/mysql
    networks:
      - nginx-proxy

  # --- The phpMyAdmin GUI Service ---
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin_gui
    restart: unless-stopped
    environment:
      # PMA_HOST tells phpMyAdmin the hostname of the database to connect to.
      # 'db' is the SERVICE NAME of our MySQL container above.
      PMA_HOST: db
      PMA_PORT: 3306
    ports:
    - "8082:80" # Map host port 8082 to the container's internal port 80
    depends_on:
      - db # Ensures the database starts before phpMyAdmin tries to connect.
    networks:
      - nginx-proxy

# Declare that our shared network is external and pre-existing.
networks:
  nginx-proxy:
    external: true
</code></pre>
                    <div class="info-box"><p><strong>Remember to replace the placeholder passwords before saving the file!</strong></p></div>

                    <h3>Step 3: Launch the Database Service</h3>
                    <p>Navigate to the new directory and start the services.</p>
                    <pre><code class="language-bash"># Navigate into the database project directory
cd /root/docker-deployment/database

# Start the services in detached mode (-d)
docker compose up -d
</code></pre>
                    <p>Docker will now download the images and start your database stack. A folder named `mysql-data` will appear, safely storing your database.</p>
                    <p>You can access the phpMyAdmin login page directly at <code>http://YOUR_SERVER_IP:8082</code>.</p>
                </section>

                <section id="section-3">
                    <h2>Part 2: Securely Accessing phpMyAdmin</h2>
                    <p>We will use Nginx Proxy Manager to give phpMyAdmin a secure, easy-to-remember domain name with an SSL certificate.</p>
                    <ol>
                        <li><strong>Point a Subdomain:</strong> In your domain registrar (e.g., Namecheap), create a new 'A' record for a subdomain like <code>dbadmin.yourdomain.com</code> and point it to your server's IP address.</li>
                        <li><strong>Log in to Nginx Proxy Manager.</strong></li>
                        <li><strong>Add a New Proxy Host:</strong>
                            <ul>
                                <li><strong>Details Tab:</strong>
                                    <ul>
                                        <li><strong>Domain Names:</strong> <code>dbadmin.yourdomain.com</code></li>
                                        <li><strong>Scheme:</strong> <code>http</code></li>
                                        <li><strong>Forward Hostname / IP:</strong> <code>phpmyadmin</code> (This MUST be the service name from your `docker-compose.yml`).</li>
                                        <li><strong>Forward Port:</strong> <code>80</code> (The internal port of the phpMyAdmin container).</li>
                                    </ul>
                                </li>
                                <li><strong>SSL Tab:</strong> Select "Request a new SSL Certificate" and turn on "Force SSL".</li>
                                <li><strong>Save.</strong></li>
                            </ul>
                        </li>
                    </ol>
                    <p>After a minute, you can access your secure phpMyAdmin interface at <code>https://dbadmin.yourdomain.com</code>. Log in with username <code>root</code> and the `MYSQL_ROOT_PASSWORD` you set.</p>
                </section>
                
                <section id="section-4">
                    <h2>Part 3: Connecting Your Application</h2>
                    <p>Now, let's connect your deployed Flask application to this new database.</p>
                    <h3>Step 1: Update Application Dependencies</h3>
                    <p>Your application needs a database driver. For a Flask app using `pymysql`, your <code>requirements.txt</code> should include:</p>
                    <pre><code class="language-text"># In your app's requirements.txt
flask
gunicorn
pymysql
cryptography # Required for modern MySQL 8 authentication
</code></pre>
                    
                    <h3>Step 2: Configure the Connection String</h3>
                    <p>In your Flask `app.py`, configure the connection details. The key is using the database service name (`db`) as the host, which only works when both containers are on the same Docker network.</p>
                    <pre><code class="language-python"># In your app.py
# --- Database Configuration ---
app.config['MYSQL_HOST'] = 'db' # The service name of the MySQL container
app.config['MYSQL_USER'] = 'your_app_user'
app.config['MYSQL_PASSWORD'] = 'your_app_password'
app.config['MYSQL_DB'] = 'your_app_database'

# ... rest of your application code ...
</code></pre>

                    <h3>Step 3: Rebuild and Restart Your App</h3>
                    <p>Since you've changed the requirements and code, you must rebuild your app's Docker image.</p>
                    <pre><code class="language-bash"># Navigate to your specific application's directory
cd /root/docker-deployment/apps/your_app_name

# Rebuild the image and restart the containers
docker compose up --build -d
</code></pre>
                    <p>Your application will now connect to the central database container over the shared `nginx-proxy` network.</p>
                </section>
                
                <section id="section-5">
                    <h2>Part 4: Database Management</h2>
                    <h3>Useful Docker Commands</h3>
                    <p>Run these commands from within the <code>/root/docker-deployment/database/</code> directory.</p>
                    <pre><code class="language-bash"># See the logs for the MySQL container (useful for debugging)
docker compose logs -f db

# Stop the database services without deleting data
docker compose stop

# Start the database services again
docker compose start

# Stop and REMOVE the containers (your data is safe in the 'mysql-data' folder)
docker compose down
</code></pre>

                    <h3>Creating New Databases and Users via phpMyAdmin</h3>
                    <p>For each new application, you should create a dedicated database and user following the Principle of Least Privilege.</p>
                    <ol>
                        <li>Log into phpMyAdmin as the <code>root</code> user.</li>
                        <li>Go to the **"User accounts"** tab and click **"Add user account"**.</li>
                        <li>Enter a new **User name** and a strong **Password**.</li>
                        <li>Under "Database for user account", select the option ‚úÖ **"Grant all privileges on database..."** and choose the specific database you want this user to access.</li>
                        <li>Ensure the "Global privileges" checkbox at the bottom of the page is **NOT** checked.</li>
                        <li>Click **"Go"** at the bottom.</li>
                    </ol>
                    <p>You now have a new, secure, isolated database user for your project.</p>

                    <h3>Backing Up Your Data</h3>
                    <p>All MySQL data is stored in the <code>/root/docker-deployment/database/mysql-data</code> folder. To create a backup, you simply need to copy this folder.</p>
                    <pre><code class="language-bash"># First, stop the database to ensure data consistency
cd /root/docker-deployment/database
docker compose stop db

# Create a compressed backup file of your entire database folder
tar -czvf /root/mysql_backup_$(date +%F).tar.gz /root/docker-deployment/database/mysql-data

# Restart the database
docker compose start db
</code></pre>
                    <p>You can then download the `mysql_backup_YYYY-MM-DD.tar.gz` file using an SFTP client.</p>
                </section>
                
                <section id="section-6">
                    <h2>Part 5: Allowing External Connections (Advanced)</h2>
                    <div class="info-box" style="border-color: #dc3545;">
                        <p><strong>‚ö†Ô∏è Security Warning:</strong> Exposing your database to the public internet is a significant security risk. Only do this for temporary needs like local development and ensure you have strong passwords. It is always more secure to have your applications connect over the private Docker network.</p>
                    </div>
                    <p>If you must allow external connections (e.g., from your local PC for development), follow these three steps.</p>
                    
                    <h3>Step 1: Update `docker-compose.yml`</h3>
                    <p>You need to modify your <code>database/docker-compose.yml</code> to map the MySQL port to your host server. Below is the complete file with the required `ports` section added to the `db` service.</p>
                    <pre><code class="language-yaml">services:
  # --- The MySQL Database Service ---
  db:
    image: mysql:8.0
    container_name: mysql_db
    restart: unless-stopped
    environment:
      # These passwords should be very strong if exposing the DB.
      MYSQL_ROOT_PASSWORD: YOUR_VERY_STRONG_ROOT_PASSWORD
      MYSQL_PASSWORD: YOUR_STRONG_USER_PASSWORD
      MYSQL_USER: flask_user
      MYSQL_DATABASE: flask_db
    ports:
      # This line maps your server's public port 3306 to the container's private port 3306.
      - "3306:3306"
    volumes:
      - ./mysql-data:/var/lib/mysql
    networks:
      - nginx-proxy

  # --- The phpMyAdmin GUI Service (no changes needed here) ---
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin_gui
    restart: unless-stopped
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
    ports:
    - "8082:80"
    depends_on:
      - db
    networks:
      - nginx-proxy

networks:
  nginx-proxy:
    external: true
</code></pre>
                        
                    <h3>Step 2: Apply the Change and Open Firewall</h3>
                    <ol>
                        <li>
                            <strong>Restart the Service:</strong> Navigate to the database directory and run `up` to apply the port mapping.
                            <pre><code class="language-bash">cd /root/docker-deployment/database
docker compose up -d
</code></pre>
                        </li>
                        <li>
                            <strong>Open Firewall Port:</strong> In your VPS provider's firewall settings, create a rule to **ALLOW inbound TCP traffic on port 3306**. For added security, you can restrict the source to your home or office IP address.
                        </li>
                    </ol>
                    
                    <h3>Step 3: Connect from Your Local Application</h3>
                    <p>You can now configure your local development application to connect using your server's public IP as the host.</p>
                     <pre><code class="language-python"># In your LOCAL app.py for development
app.config['MYSQL_HOST'] = 'YOUR_SERVER_IP' # Use the server's public IP
app.config['MYSQL_USER'] = 'your_app_user'
app.config['MYSQL_PASSWORD'] = 'your_app_password'
app.config['MYSQL_DB'] = 'your_app_database'
</code></pre>
                </section>


                <section id="section-7">
                    <h2>Part 6: Decommissioning the Database</h2>
                    <p>If you no longer need your database, it's important to remove it cleanly to free up system resources. Follow these steps in order to permanently remove the database, phpMyAdmin, and all associated data.</p>
                    
                    <ol>
                        <li>
                            <strong>Remove the Proxy Host:</strong> First, remove the public-facing entry point. Log into Nginx Proxy Manager, find the host for your phpMyAdmin (e.g., <code>dbadmin.yourdomain.com</code>), click the three-dot menu, and delete it.
                        </li>
                        <li>
                            <strong>Take Down the Docker Services:</strong> Navigate to the database project directory on your server and run the `down` command. The `-v` flag is important as it removes any anonymous volumes created by the containers.
                            <pre><code class="language-bash"># Navigate to the database project directory
cd /root/docker-deployment/database

# Stop and remove the containers
docker compose down -v
</code></pre>
                        </li>
                        <li>
                            <strong>Permanently Delete All Database Data:</strong> This is the most critical and irreversible step. The following command will delete the folder containing all of your MySQL databases.
                            <div class="info-box" style="border-color: #dc3545;">
                                <p><strong>‚ö†Ô∏è WARNING:</strong> This action will permanently delete all your database data. There is no undo. Make sure you have a backup if you ever want to restore this data.</p>
                            </div>
                            <pre><code class="language-bash"># This deletes the mysql-data folder and everything inside it
rm -rf /root/docker-deployment/database/mysql-data
</code></pre>
                        </li>
                        <li>
                            <strong>Delete the Project Directory:</strong> Finally, clean up the remaining project files, including the `docker-compose.yml`.
                            <pre><code class="language-bash"># Go up one directory level
cd /root/docker-deployment

# Delete the entire database project folder
rm -rf database
</code></pre>
                        </li>
                    </ol>
                    <p>The central database and phpMyAdmin have now been completely removed from your server.</p>
                </section>
            </div>
        </main>
    </div>

    <!-- Scripts at the end of the body -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre').forEach(pre => { /* ... Copy Button Logic ... */ });
            const themeToggle = document.getElementById('checkbox'); /* ... Theme Toggle Logic ... */
            // Full JS from previous guides can be pasted here
            document.querySelectorAll('pre').forEach(pre => { const code = pre.querySelector('code'); if (code) { const button = document.createElement('button'); button.innerText = 'Copy'; button.className = 'copy-button'; pre.appendChild(button); button.addEventListener('click', () => { navigator.clipboard.writeText(code.innerText).then(() => { button.innerText = 'Copied!'; setTimeout(() => { button.innerText = 'Copy'; }, 2000); }); }); } }); const currentTheme = localStorage.getItem('theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); themeToggle.checked = theme === 'dark'; }; if (currentTheme) { applyTheme(currentTheme); } else if (prefersDark) { applyTheme('dark'); } themeToggle.addEventListener('change', function() { const theme = this.checked ? 'dark' : 'light'; document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); });
        });
    </script>
</body>
</html>